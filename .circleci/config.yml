#
# CircleCI 2.0
#
version: 2
jobs:
  build:
    docker:
      - image: nalbam/builder:node
#    working_directory: /work
    steps:
      - checkout
      - run: mkdir -p target
      - run: cd src && npm install && zip -r ../target/lambda.zip *
      - persist_to_workspace:
          root: target
          paths:
            - lambda.zip
      - store_artifacts:
          path: target/lambda.zip
  infra:
    docker:
      - image: hashicorp/terraform:light
    steps:
      - checkout
      - attach_workspace:
          at: target
      - run: terraform init
      - run: terraform apply -auto-approve -var="version=1.0.${CIRCLE_BUILD_NUM}"
#  deploy:
#    docker:
#      - image: nalbam/builder:python
#    steps:
#      - checkout
#      - attach_workspace:
#          at: /work/target
#      - run: aws configure set default.region ap-northeast-2
#      - run: aws s3 cp /work/target/lambda.zip s3://${bucket}/${S3_KEY}
#      - run: aws lambda update-function-code --function-name ${function} --s3-bucket ${bucket} --s3-key ${S3_KEY}

workflows:
  version: 2
  lambda:
    jobs:
      - build
      - infra:
          requires:
            - build
